#!/bin/sh
set -e # Exit on any error
set -x # Echo all commands

# Configuration
TargetWiki="OcttKB"
TargetRepo="OcttKB"

git clone --depth 1 "https://gitlab.com/octtspacc/$TargetRepo" "./Repo-$TargetRepo"
cd "./Repo-$TargetRepo"
rm -rf "./Wiki-$TargetWiki" || true

tiddlywiki \
	--verbose \
	--load "../$TargetWiki.html" \
	--output "./Wiki-$TargetWiki" \
	--savewikifolder "./Wiki-$TargetWiki"

cd "./Wiki-$TargetWiki/tiddlers"

for Dir in Normal System
do mkdir -vp "../${Dir}" "../${Dir}.tmp"
done

mv \$__* ../System.tmp/ || true
mv *     ../Normal.tmp/ || true
#mv .*    ../Normal.tmp/ || true
cd ..

for TypeDir in System Normal
do
	cd "./${TypeDir}.tmp"
	for OldFile in *
	do
		#WorkDir="$PWD"
		NewFile="$(echo "${OldFile}" | sed -e 's|_|/|g')"
		BaseName="$(echo "${NewFile}" | rev | cut -d"/" -f1 | rev)"
		mkdir -p "../${TypeDir}/${NewFile}"
		rm -rf "../${TypeDir}/${NewFile}"
		mv "./${OldFile}" "../${TypeDir}/${NewFile}"
		#cd "../${TypeDir}"
		#mv "./$NewPath" "./$BaseName"
		#cd "$WorkDir"
	done
	cd ..
done

mv ./System ./System.tmp/System
mv ./System.tmp/System/\$ ./System
mv ./System ./Normal ./tiddlers
rm -rf ./System.tmp ./Normal.tmp

cd ..
GitPush "OcttKB Cross-Repo Sync (HTML to Raw)"
